#!/bin/bash

# -----------------------------------------------------------------------------
# ct (Control Tower)
#
# The main entry point for all control-tower commands.
# This script acts as a router to other specialized scripts.
# -----------------------------------------------------------------------------

set -euo pipefail

# Find the directory where this script is located
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)

# Check if any command is provided
if [ -z "${1:-}" ]; then
  # --- Dynamic Interactive Mode ---
  echo "What would you like to do?"

  # 1. Find all 'create-*' scripts and build menu options
  scripts_dir="${SCRIPT_DIR}/../scripts"
  options=()
  script_files=()
  for script in "$scripts_dir"/create-*.sh; do
    if [ -f "$script" ]; then
      # Extract 'story' from 'create-story.sh'
      type=$(basename "$script" .sh | sed -e 's/create-//')
      # Capitalize the first letter and create a user-friendly option
      options+=("Create a new ${type} project")
      script_files+=("$script")
    fi
  done
  options+=("Quit")

  # 2. Display the menu and handle user selection
  select opt in "${options[@]}"; do
    # Handle the "Quit" option
    if [[ "$opt" == "Quit" ]]; then
      echo "Exiting."
      break
    fi

    # Handle script execution for other options
    if [[ -n "$opt" ]]; then
      read -p "Enter the project name: " PROJECT_NAME
      if [ -n "$PROJECT_NAME" ]; then
        # Find the corresponding script file for the selected option
        selected_script="${script_files[$((REPLY-1))]}"
        bash "$selected_script" "$PROJECT_NAME"
      else
        echo "Project name cannot be empty." >&2
      fi
      break
    else
      echo "Invalid option $REPLY. Please try again."
    fi
  done
  exit 0
fi

COMMAND=$1 # e.g., "new"

case "$COMMAND" in
  new)
    SUB_COMMAND=${2:-} # Safely get the second argument (e.g., "story")
    PROJECT_NAME=${3:-} # Safely get the third argument (the project name)

    # Validate that a subcommand and project name are provided
    if [ -z "$SUB_COMMAND" ] || [ -z "$PROJECT_NAME" ]; then
      echo "Error: Both a type and project name are required." >&2
      echo "Usage: $0 new <type> <project-name>" >&2
      exit 1
    fi

    # Construct the expected script path from the subcommand
    TARGET_SCRIPT="${SCRIPT_DIR}/../scripts/create-${SUB_COMMAND}.sh"

    # Check if the corresponding script exists
    if [ -f "$TARGET_SCRIPT" ]; then
      # Execute the script if it exists
      bash "$TARGET_SCRIPT" "$PROJECT_NAME"
    else
      # If not, show an error with available types
      available_types=$(ls -1 "${SCRIPT_DIR}/../scripts" | grep 'create-.*\.sh' | sed -e 's/create-//' -e 's/\.sh//' | tr '\n' ' ')
      echo "Error: Unknown type '$SUB_COMMAND'." >&2
      echo "Available types: ${available_types}" >&2
      exit 1
    fi
    ;;
  *)
    echo "Error: Unknown command '$COMMAND'. Available: 'new'" >&2
    echo "Usage: $0 new story <project-name>" >&2
    exit 1
    ;;
esac
